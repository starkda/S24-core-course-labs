# Kubernetes Secrets and Hashicorp Vault

## 1st task

### Managing secrets with kubectl

Creating a secret using `kubectl`:

```
djovi@djovi-NBD-WXX9:~/PycharmProjects/S24-core-course-labs/k8s$  kubectl create secret generic my-secret --from-literal=username='dzhovi' --from-literal=password='1337'
secret/my-secret created
```

```
djovi@djovi-NBD-WXX9:~/PycharmProjects/S24-core-course-labs/k8s$  kubectl get secrets --namespace=default
NAME                               TYPE                 DATA   AGE
empty-secret                       Opaque               0      27s
my-secret                          Opaque               2      13s
sh.helm.release.v1.app-python.v1   helm.sh/release.v1   1      5d19h
sh.helm.release.v1.helm-hooks.v1   helm.sh/release.v1   1      5d20h
```

Confirmation:

```
djovi@djovi-NBD-WXX9:~/PycharmProjects/S24-core-course-labs/k8s$  kubectl describe secret my-secret
Name:         my-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  4 bytes
username:  6 bytes
```

## Managing secrets with Helm:

installing plugin:

```
helm plugin install https://github.com/zendesk/helm-secrets
```

verifying via running `helm secrets help`:
```
djovi@djovi-NBD-WXX9:~/PycharmProjects/S24-core-course-labs/k8s$ helm secrets help
GnuPG secrets encryption in Helm Charts

This plugin provides ability to encrypt/decrypt secrets files
to store in less secure places, before they are installed using
Helm.

To decrypt/encrypt/edit you need to initialize/first encrypt secrets with
sops - https://github.com/mozilla/sops

Available Commands:
  enc           Encrypt secrets file
  dec           Decrypt secrets file
  view          Print secrets decrypted
  edit          Edit secrets file and encrypt afterwards
  clean         Remove all decrypted files in specified directory (recursively)
  install       wrapper that decrypts secrets[.*].yaml files before running helm install
  template      wrapper that decrypts secrets[.*].yaml files before running helm template
  upgrade       wrapper that decrypts secrets[.*].yaml files before running helm upgrade
  lint          wrapper that decrypts secrets[.*].yaml files before running helm lint
  diff          wrapper that decrypts secrets[.*].yaml files before running helm diff
                  (diff is a helm plugin)

```
decryption of `secrets.yaml`:
```
djovi@djovi-NBD-WXX9:~/PycharmProjects/S24-core-course-labs/k8s$  helm secrets view secrets.yaml 
password: 123
```
installing app:
```
djovi@djovi-NBD-WXX9:~/PycharmProjects/S24-core-course-labs/k8s$ helm secrets install app-python ./app-python -n default -f ./secrets.yaml
W0413 16:33:42.759999  346698 warnings.go:70] unknown field "env"
NAME: app-python
LAST DEPLOYED: Sat Apr 13 16:33:19 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services app-python)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
removed './secrets.yaml.dec'
```
output of kubectl get po:
```
djovi@djovi-NBD-WXX9:~/PycharmProjects/S24-core-course-labs/k8s$ kubectl get po
NAME                          READY   STATUS    RESTARTS   AGE
app-python-5b6bdb64f9-dwzbt   1/1     Running   0          5m19s
```
output of variable:
```
djovi@djovi-NBD-WXX9:~/PycharmProjects/S24-core-course-labs/k8s$ kubectl exec app-python-5b6bdb64f9-dwzbt -- printenv | grep MY_PASSWORD
MY_PASSWORD=123
```

## VaultHashiCorp
`helm install vault hashicorp/vault --set "server.dev.enabled=true"`:
```
djovi@djovi-NBD-WXX9: kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/server/config password="123"
======= Secret Path =======
internal/data/server/config
======= Metadata =======
Key                Value
---                -----
created_time       2024-04-07T23:28:34.203352345Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/server/config
======= Secret Path =======
internal/data/server/config
======= Metadata =======
Key                Value
---                -----
created_time       2024-04-07T23:28:34.203352345Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
====== Data ======
Key         Value
---         -----
password    123
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/server/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit
```
```
djovi@djovi-NBD-WXX9: kubectl get po
NAME                                     READY   STATUS    RESTARTS   AGE
app-python-5b6bdb64f9-dwzbt          1/1     Running   0          69m
vault-0                                  1/1     Running   0          8m15s
vault-agent-injector-343gh9u3e-3ayoi     1/1     Running   0          8m15s
```

```
djovi@djovi-NBD-WXX9:  kubectl exec -it app-python-5b6bdb64f9-dwzbt  -- /bin/sh
/app cat /vault/secrets/config.txt
data: map[password:123]
metadata: map[created_time:2024-04-13T23:13:22.202467214Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
/app df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay          64G   53G  2.0G  94% /
tmpfs            64M     0   64M   0% /dev
/dev/nvme0n1p5   64G   59G   64G  94% /etc/hosts
tmpfs           7.3G  4.0K  7.3G   1% /vault/secrets
shm              64M     0   64M   0% /dev/shm
tmpfs           7.3G   14G  7.3G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           3.8G     0  3.8G   0% /proc/asound
tmpfs           3.8G     0  3.8G   0% /proc/acpi
tmpfs           3.8G     0  3.8G   0% /proc/scsi
tmpfs           3.8G     0  3.8G   0% /sys/firmware
```